<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ user }}'s Messages</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    @font-face {
      font-family: 'Englibesh';
      src: url("{{ url_for('static', filename='fonts/Englibesh.ttf') }}") format("truetype");
    }
  </style>
</head>
<body class="starwars-bg">

    {% include "_header.html" %}

    <div class="content">

        {% if not chat_name %}
        <h1 class="title">{{ t["your_conversations"] }}</h1>
        {% if chats %}
        <ul class="chat-list">
            {% for name, chat in chats.items() %}
            {% set unread = chat["messages"] | selectattr("read", "equalto", false) | selectattr("from", "ne", user) | list | length %}
            <li>
                <a href="{{ url_for('messages', chat=name) }}">
                    {{ name }}{% if unread > 0 %} <span class="unread">{{ t["new"] }}</span>{% endif %}
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>{{ t["no_conversations"] }}</p>
        {% endif %}
        <div class="scifi-container">
          <div class="scifi-container-header">
            <h2 class="subtitle">{{ t["start_new_conversation"] }}</h2>
          </div>
          <div class="scifi-container-content">
            <form method="POST" id="startConvoForm" action="{{ url_for('messages') }}">
                <label for="recipient">{{ t["recipient"] }}:</label>
                <input type="text" id="recipient" name="recipient" placeholder='{{ t["recipient_ph"] }}' required>

                <label for="new_chat_name">{{ t["chat_name"] }}:</label>
                <input type="text" id="new_chat_name" name="new_chat_name" placeholder='{{ t["chat_name_ph"] }}' required>

                <label for="message">{{ t["message"] }}:</label>
                <textarea id="message" name="message" placeholder='{{ t["message_ph"] }}' required></textarea>

                <button type="submit" name="start_chat">{{ t["send"] }}</button>
            </form>
          </div>
        </div>

        {% else %}
        <h1 class="title">{{ chat_name }}</h1>

        {% if chats[chat_name]["messages"] %}
        <div class="chat-thread">
            {% for msg in chats[chat_name]["messages"] %}
            <div class="chat-bubble">
              <div class="chat-bubble-header">
                <p class="chat-bubble-sender">{{ msg.from }}</p>
              </div>
              <div class="chat-bubble-content">
                <p>{{ msg.content }}</p></div>
              <div class="chat-bubble-footer"></div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>{{ t["no_messages"] }}</p>
        {% endif %}

        <h2 class="subtitle">{{ t["send_reply_title"] }}</h2>
        <form method="POST" id="replyForm" action="{{ url_for('messages') }}">
            <input type="hidden" name="chat_name" value="{{ chat_name }}">
            <textarea class="chat-message" name="message" placeholder='{{ t["reply_ph"] }}' required></textarea>
            <button type="submit" id="replyButton">{{ t["send"] }}</button>
        </form>
        <hr>
        <a href="{{ url_for('messages') }}"><button>{{ t["back_to_conversations"] }}</button></a>
        {% endif %}
    </div>

    <audio id="send-sound" src="{{ url_for('static', filename='sounds/beep.mp3') }}"></audio>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const sendSound = document.getElementById("send-sound");
        const forms = document.querySelectorAll("form");
        forms.forEach(form => {
          form.addEventListener("submit", () => {
            setTimeout(() => sendSound.play(), 300);
          });
        });
      });
    </script>


</body>
</html>
