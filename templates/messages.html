<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ user }}'s Messages</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    @font-face {
      font-family: 'Englibesh';
      src: url("{{ url_for('static', filename='fonts/Englibesh.ttf') }}") format("truetype");
    }
  </style>
</head>
<body class="starwars-bg">

    {% include "_header.html" %}

    <div class="content">

        {% if not chat_id %}
        <h1 class="title">{{ t["your_conversations"] }}</h1>
        {% if chats %}
        <ul class="chat-list">
            {% for chat in chats %}
            {% set unread = chat["messages"] | selectattr("read", "equalto", false) | selectattr("from", "ne", user) | list | length %}
            <li>
                <a href="{{ url_for('messages', chat=chat["id"]) }}">
                  <span>{{ chat["chat_name"] }}{% if unread > 0 %} <span class="unread">{{ t["new"] }}</span>{% endif %}</span>
                  <span class="chat-participants">
                    {% for p in chat["participants"] %}
                      {%if p != user %}
                        <span class="chat-member">{{p}}</span>
                      {% endif %}
                    {% endfor %}
                  </span>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>{{ t["no_conversations"] }}</p>
        {% endif %}
        <div class="scifi-container">
          <div class="scifi-container-header">
            <h2 class="subtitle">{{ t["start_new_conversation"] }}</h2>
          </div>
          <div class="scifi-container-content">
            <form method="POST" id="startConvoForm" action="{{ url_for('messages') }}">
                <label for="recipient">{{ t["recipient"] }}:</label>

                <div class="field" style="position:relative">
                  <input id="recipient" type="text" autocomplete="off" role="combobox" name="recipient" placeholder='{{ t["recipient_ph"] }}' required
                         aria-autocomplete="list" aria-expanded="false" aria-controls="character-list" aria-activedescendant="">
                  <div id="character-list" role="listbox" class="listbox" hidden></div>
                  <div id="status" class="sr-only" role="status" aria-live="polite"></div>
                </div>

                <label for="new_chat_name">{{ t["chat_name"] }}:</label>
                <input type="text" id="new_chat_name" name="new_chat_name" placeholder='{{ t["chat_name_ph"] }}' required>

                <input type="hidden" id="new_chat_id" name="new_chat_id">

                <label for="message">{{ t["message"] }}:</label>
                <textarea id="message" name="message" placeholder='{{ t["message_ph"] }}' required></textarea>

                <button type="submit" name="start_chat">{{ t["send"] }}</button>
            </form>
          </div>



        </div>

        {% else %}

        {% for chat in chats %}
            {% if chat["id"] == chat_id %}
                <h1 class="title">{{ chat["chat_name"] }}</h1>
                <div class="chat-thread">
                    {% for msg in chat["messages"] %}
                    <div class="chat-bubble">
                      <div class="chat-bubble-header">
                        <p class="chat-bubble-sender">{{ msg.from }}</p>
                      </div>
                      <div class="chat-bubble-content">
                        <p>{{ msg.content }}</p></div>
                      <div class="chat-bubble-footer"></div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}

        <h2 class="subtitle">{{ t["send_reply_title"] }}</h2>
        <form method="POST" id="replyForm" action="{{ url_for('messages') }}">
            <input type="hidden" name="chat_name" value="{{ chat_name }}">
            <input type="hidden" name="chat_id" value="{{ chat_id }}">
            <textarea class="chat-message" name="message" placeholder='{{ t["reply_ph"] }}' required></textarea>
            <button type="submit" id="replyButton">{{ t["send"] }}</button>
        </form>
        <hr>
        <a href="{{ url_for('messages') }}"><button>{{ t["back_to_conversations"] }}</button></a>
        {% endif %}
    </div>

    <audio id="send-sound" src="{{ url_for('static', filename='sounds/beep.mp3') }}"></audio>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const sendSound = document.getElementById("send-sound");
        const forms = document.querySelectorAll("form");
        forms.forEach(form => {
          form.addEventListener("submit", () => {
            setTimeout(() => sendSound.play(), 300);
          });
        });
      });
    </script>
    <script>
      /** autocomplete for recipient input **/
      (() => {
        const CHARACTERS = Object.keys({{ characters|tojson }});

        const input  = document.getElementById('recipient');
        const list   = document.getElementById('character-list');
        const status = document.getElementById('status');

        if (input) {

          let items = [];         // aktuelle Treffer
          let activeIndex = -1;   // f체r Tastatur-Navigation

          const debounce = (fn, ms=120) => { let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} };

          function render(options){
            list.innerHTML = "";
            options.forEach((opt, i) => {
              const div = document.createElement('div');
              div.id = `opt-${i}`;
              div.role = "option";
              div.className = "option";
              div.textContent = opt;
              div.setAttribute("aria-selected", String(i===activeIndex));
              div.addEventListener('mousedown', (e) => { // mousedown, damit blur nicht vorher feuert
                e.preventDefault();
                choose(i);
              });
              list.appendChild(div);
            });
            const open = options.length > 0;
            list.hidden = !open;
            input.setAttribute("aria-expanded", String(open));
            status.textContent = open ? `${options.length} Vorschl채ge` : "Keine Vorschl채ge";
            input.setAttribute("aria-activedescendant", activeIndex>=0 ? `opt-${activeIndex}` : "");
          }

          function choose(i){
            if (i < 0 || i >= items.length) return;
            input.value = items[i];
            closeList();
          }

          function closeList(){
            items = [];
            activeIndex = -1;
            render(items);
          }

          const update = debounce(() => {
            const q = input.value.trim().toLowerCase();
            if (!q) { closeList(); return; }
            items = CHARACTERS.filter(x => x.toLowerCase().includes(q)).slice(0, 8);
            activeIndex = items.length ? 0 : -1;
            render(items);
          }, 120);

          input.addEventListener('input', update);

          input.addEventListener('keydown', (e) => {
            if (e.key === "ArrowDown" && list.hidden) {
              items = CHARACTERS.slice(0, 20);
              activeIndex = 0;
              render(items);
              e.preventDefault();
            }
            if (list.hidden && (e.key === "ArrowDown" || e.key === "Enter")) { update(); return; }
            if (e.key === "ArrowDown") {
              if (items.length) { activeIndex = (activeIndex + 1) % items.length; render(items); }
              e.preventDefault();
            } else if (e.key === "ArrowUp") {
              if (items.length) { activeIndex = (activeIndex - 1 + items.length) % items.length; render(items); }
              e.preventDefault();
            } else if (e.key === "Enter") {
              if (!list.hidden && activeIndex >= 0) { choose(activeIndex); e.preventDefault(); }
            } else if (e.key === "Escape") {
              closeList();
              input.select();
            }
          });

          input.addEventListener('mousedown', (e) => {
              items = CHARACTERS.slice();
              if (list.hidden) render(items);
          });


          input.addEventListener('blur', () => setTimeout(closeList, 100)); // kurz warten f체r Maus-Klick
        }
      })();


    </script>

</body>
</html>
